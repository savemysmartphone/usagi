#!/usr/bin/env ruby
require 'rspec'
require 'usagi'

Usagi.start

ENV['RAILS_ENV']  = 'test'

begin
  argv_list = ARGV
  argv_list += Dir['./spec/usagi/**/*.rb'] unless ARGV.any?{|argv| argv =~ /\.rb$/ }
  Usagi.rspec = RSpec::Core::Runner.run(argv_list.flatten)
rescue
  puts "[usagi][#{Usagi.pid}] RSpec encountered an exception"
  Usagi.stop
  raise
end

Usagi.stop
Process.exit(Usagi.rspec) if Usagi.rspec != 0
